#!/usr/bin/env ruby

require "magelex"

require 'optparse'

program_name = File.basename __FILE__
options = {out_dir: 'lexware'}
optparse = OptionParser.new do |opts|
  opts.banner = "Usage: #{program_name} DIR_OR_FILE"
  opts.separator ""

  opts.on('-o', '--out-dir DIR', 'Directory to write output files to.') do |o|
    options[:out_dir] = o
  end
end.parse!

if ARGV.length != 1
  STDERR.puts "Need an argument (directory or file)"
  exit 1
end

Magelex.logger = Logger.new STDERR

Magelex.logger.level = options[:verbose] ? Logger::DEBUG : Logger::INFO
Magelex.logger.datetime_format = "%Y-%m-%d %H:%M:%S"
Magelex.logger.formatter = proc { |severity, datetime, progname, msg|
  "#{severity} - #{datetime} - #{msg}\n"
}

def main
  Magelex.logger.info("Started")
  bills_export = []
  bills = Magelex::MagentoCSV.read ARGV[0]
  bills.each do |bill|
    #Magelex.logger.info("Order #{bill.order_nr} Status #{bill.status}")
    if !bill.complete?
      Magelex.logger.info("Skip order #{bill.order_nr} (incomplete: #{bill.status})")
    else # complete!
      bill.consume_shipping_cost
      bill.swissify
      if !bill.check
        Magelex.logger.info("Skip order #{bill.order_nr} (totals do not match #{bill.total} != (0: #{bill.total_0} + 7: #{bill.total_7} + 19: #{bill.total_19})")
      else
        Magelex.logger.debug("Handle #{bill.order_nr}")
        bills_export << bill
      end
    end
  end
  puts Magelex::LexwareCSV.render bills_export
end

main
